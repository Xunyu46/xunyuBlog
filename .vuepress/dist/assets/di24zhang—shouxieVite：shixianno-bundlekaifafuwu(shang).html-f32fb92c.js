import{_ as e,r as o,o as c,c as i,b as s,d as n,e as p,a}from"./app-48690364.js";const l={},u=a('<p>åœ¨ä¸Šä¸€ç« ä¸­ï¼Œæˆ‘ä»¬ä¸€èµ·ç³»ç»Ÿå­¦ä¹ äº† Vite çš„å®ç°æºç ï¼Œä»é…ç½®è§£æã€ä¾èµ–é¢„æ„å»ºã€æ’ä»¶æµæ°´çº¿å’Œ HMR è¿™å‡ ä¸ªæ–¹é¢å¸¦ä½ å®Œæ•´çš„æ¢³ç†äº† Vite çš„åº•å±‚åŸç†ï¼Œé‚£ä¹ˆï¼Œåœ¨æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†è¿›ä¸€æ­¥ï¼Œç”¨å®é™…çš„ä»£ç æ¥å†™ä¸€ä¸ªè¿·ä½ ç‰ˆçš„ Viteï¼Œä¸»è¦å®ç° Vite æœ€æ ¸å¿ƒçš„ no-bundle æ„å»ºæœåŠ¡ã€‚åœ¨å­¦å®Œæœ¬èŠ‚ä¹‹åï¼Œä½ ä¸ä»…èƒ½å¤Ÿå¤ä¹ ä¹‹å‰æ‰€ä»‹ç»çš„å„ç§åŸç†ï¼Œä¹Ÿèƒ½æ·±å…¥åœ°ç†è§£ä»£ç å±‚é¢çš„å®ç°ç»†èŠ‚ï¼Œæ‹¥æœ‰ç‹¬ç«‹å¼€å‘ä¸€ä¸ª no-bundle æ„å»ºå·¥å…·çš„èƒ½åŠ›ã€‚</p><h2 id="å®æˆ˜æ¦‚è§ˆ" tabindex="-1"><a class="header-anchor" href="#å®æˆ˜æ¦‚è§ˆ" aria-hidden="true">#</a> å®æˆ˜æ¦‚è§ˆ</h2><p>ç›¸è¾ƒäºå‰é¢çš„å°èŠ‚ï¼Œæœ¬å°èŠ‚(ä»¥åŠä¸‹ä¸€å°èŠ‚)çš„å†…å®¹ä¼šæ¯”è¾ƒéš¾ï¼Œæ‰‹å†™çš„ä»£ç é‡ä¹Ÿæ¯”è¾ƒå¤š(æ€»å…±è¿‘ä¸€åƒè¡Œ)ã€‚å› æ­¤ï¼Œåœ¨å¼€å§‹ä»£ç å®æˆ˜ä¹‹å‰ï¼Œæˆ‘å…ˆç»™å¤§å®¶æ¢³ç†ä¸€ä¸‹éœ€è¦å®Œæˆçš„æ¨¡å—å’ŒåŠŸèƒ½ï¼Œè®©å¤§å®¶æœ‰ä¸€ä¸ªæ•´ä½“çš„è®¤çŸ¥:</p><ol><li><p>é¦–å…ˆï¼Œæˆ‘ä»¬ä¼šè¿›è¡Œå¼€å‘ç¯å¢ƒçš„æ­å»ºï¼Œå®‰è£…å¿…è¦çš„ä¾èµ–ï¼Œå¹¶æ­å»ºé¡¹ç›®çš„æ„å»ºè„šæœ¬ï¼ŒåŒæ—¶å®Œæˆ cli å·¥å…·çš„åˆå§‹åŒ–ä»£ç ã€‚</p></li><li><p>ç„¶åæˆ‘ä»¬æ­£å¼å¼€å§‹å®ç°<code>ä¾èµ–é¢„æ„å»º</code>çš„åŠŸèƒ½ï¼Œé€šè¿‡ Esbuild å®ç°ä¾èµ–æ‰«æå’Œä¾èµ–æ„å»ºçš„åŠŸèƒ½ã€‚</p></li><li><p>æ¥ç€å¼€å§‹æ­å»º Vite çš„æ’ä»¶æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯å¼€å‘ <code>PluginContainer</code> å’Œ <code>PluginContext</code> ä¸¤ä¸ªä¸»è¦çš„å¯¹è±¡ã€‚</p></li><li><p>æ­å»ºå®Œæ’ä»¶æœºåˆ¶ä¹‹åï¼Œæˆ‘ä»¬å°†ä¼šå¼€å‘ä¸€ç³»åˆ—çš„æ’ä»¶æ¥å®ç° no-bundle æœåŠ¡çš„ç¼–è¯‘æ„å»ºèƒ½åŠ›ï¼ŒåŒ…æ‹¬å…¥å£ HTML å¤„ç†ã€ TS/TSX/JS/TSX ç¼–è¯‘ã€CSS ç¼–è¯‘å’Œé™æ€èµ„æºå¤„ç†ã€‚</p></li><li><p>æœ€åï¼Œæˆ‘ä»¬ä¼šå®ç°ä¸€å¥—ç³»ç»ŸåŒ–çš„æ¨¡å—çƒ­æ›´æ–°çš„èƒ½åŠ›ï¼Œä»æ­å»ºæ¨¡å—ä¾èµ–å›¾å¼€å§‹ï¼Œé€æ­¥å®ç° HMR æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„å¼€å‘ã€‚</p></li></ol><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/97c40a3172e54cc493db001f1879e025~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><h2 id="æ­å»ºå¼€å‘ç¯å¢ƒ" tabindex="-1"><a class="header-anchor" href="#æ­å»ºå¼€å‘ç¯å¢ƒ" aria-hidden="true">#</a> æ­å»ºå¼€å‘ç¯å¢ƒ</h2>',6),r={href:"https://github.com/sanyuan0704/juejin-book-vite/tree/main/mini-vite",target:"_blank",rel:"noopener noreferrer"},k=a(`<p>é¦–å…ˆï¼Œä½ å¯ä»¥æ‰§è¡Œ<code>pnpm init -y</code>æ¥åˆå§‹åŒ–é¡¹ç›®ï¼Œç„¶åå®‰è£…ä¸€äº›å¿…è¦çš„ä¾èµ–ï¼Œæ‰§è¡Œå‘½ä»¤å¦‚ä¸‹:</p><blockquote><p>å¯¹äºå„ä¸ªä¾èµ–çš„å…·ä½“ä½œç”¨ï¼Œå¤§å®¶å…ˆä¸ç”¨çº ç»“ï¼Œæˆ‘å°†ä¼šåœ¨åé¢ä½¿ç”¨åˆ°ä¾èµ–çš„æ—¶å€™ä»‹ç»ã€‚</p></blockquote><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// è¿è¡Œæ—¶ä¾èµ–</span>
pnpm i cac chokidar connect debug es<span class="token operator">-</span>module<span class="token operator">-</span>lexer esbuild fs<span class="token operator">-</span>extra magic<span class="token operator">-</span><span class="token builtin">string</span> picocolors resolve rollup sirv ws <span class="token operator">-</span><span class="token constant">S</span>

<span class="token comment">// å¼€å‘ç¯å¢ƒä¾èµ–</span>
pnpm i <span class="token decorator"><span class="token at operator">@</span><span class="token function">types</span></span><span class="token operator">/</span>connect <span class="token decorator"><span class="token at operator">@</span><span class="token function">types</span></span><span class="token operator">/</span>debug <span class="token decorator"><span class="token at operator">@</span><span class="token function">types</span></span><span class="token operator">/</span>fs<span class="token operator">-</span>extra <span class="token decorator"><span class="token at operator">@</span><span class="token function">types</span></span><span class="token operator">/</span>resolve <span class="token decorator"><span class="token at operator">@</span><span class="token function">types</span></span><span class="token operator">/</span>ws tsup
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Vite æœ¬èº«ä½¿ç”¨çš„æ˜¯ Rollup è¿›è¡Œè‡ªèº«çš„æ‰“åŒ…ï¼Œä½†ä¹‹å‰ç»™å¤§å®¶ä»‹ç»çš„ tsup ä¹Ÿèƒ½å¤Ÿå®ç°åº“æ‰“åŒ…çš„åŠŸèƒ½ï¼Œå¹¶ä¸”å†…ç½® esbuild è¿›è¡Œæé€Ÿï¼Œæ€§èƒ½ä¸Šæ›´åŠ å¼ºæ‚ï¼Œå› æ­¤åœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ tsup è¿›è¡Œé¡¹ç›®çš„æ„å»ºã€‚</p><p>ä¸ºäº†æ¥å…¥ tsup æ‰“åŒ…åŠŸèƒ½ï¼Œä½ éœ€è¦åœ¨ package.json ä¸­åŠ å…¥è¿™äº›å‘½ä»¤:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token string-property property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tsup --watch&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tsup --minify&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŒæ—¶ï¼Œä½ éœ€è¦åœ¨é¡¹ç›®æ ¹ç›®å½•æ–°å»º<code>tsconfig.json</code>å’Œ<code>tsup.config.ts</code>è¿™ä¸¤ä»½é…ç½®æ–‡ä»¶ï¼Œå†…å®¹åˆ†åˆ«å¦‚ä¸‹:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// tsconfig.json</span>
<span class="token punctuation">{</span>
  <span class="token string-property property">&quot;compilerOptions&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ”¯æŒ commonjs æ¨¡å—çš„ default importï¼Œå¦‚ import path from &#39;path&#39;</span>
    <span class="token comment">// å¦åˆ™åªèƒ½é€šè¿‡ import * as path from &#39;path&#39; è¿›è¡Œå¯¼å…¥</span>
    <span class="token string-property property">&quot;esModuleInterop&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;target&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ES2020&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;moduleResolution&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;module&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ES2020&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;strict&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// tsup.config.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;tsup&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// åç»­ä¼šå¢åŠ  entry</span>
  entry<span class="token operator">:</span> <span class="token punctuation">{</span>
    index<span class="token operator">:</span> <span class="token string">&quot;src/node/cli.ts&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// äº§ç‰©æ ¼å¼ï¼ŒåŒ…å« esm å’Œ cjs æ ¼å¼</span>
  format<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;esm&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;cjs&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// ç›®æ ‡è¯­æ³•</span>
  target<span class="token operator">:</span> <span class="token string">&quot;es2020&quot;</span><span class="token punctuation">,</span>
  <span class="token comment">// ç”Ÿæˆ sourcemap</span>
  sourcemap<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token comment">// æ²¡æœ‰æ‹†åŒ…çš„éœ€æ±‚ï¼Œå…³é—­æ‹†åŒ…èƒ½åŠ›</span>
  splitting<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ç€æ–°å»º <code>src/node/cli.ts</code>æ–‡ä»¶ï¼Œæˆ‘ä»¬è¿›è¡Œ cli çš„åˆå§‹åŒ–:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/node/cli.ts</span>
<span class="token keyword">import</span> cac <span class="token keyword">from</span> <span class="token string">&quot;cac&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> cli <span class="token operator">=</span> <span class="token function">cac</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// [] ä¸­çš„å†…å®¹ä¸ºå¯é€‰å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ä»…è¾“å…¥ \`vite\` å‘½ä»¤ä¸‹ä¼šæ‰§è¡Œä¸‹é¢çš„é€»è¾‘</span>
cli
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">&quot;[root]&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Run the development server&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">alias</span><span class="token punctuation">(</span><span class="token string">&quot;serve&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">alias</span><span class="token punctuation">(</span><span class="token string">&quot;dev&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;æµ‹è¯• cli~&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cli<span class="token punctuation">.</span><span class="token function">help</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cli<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨ä½ å¯ä»¥æ‰§è¡Œ <code>pnpm start</code> æ¥ç¼–è¯‘è¿™ä¸ª<code>mini-vite</code>é¡¹ç›®ï¼Œtsup ä¼šç”Ÿæˆäº§ç‰©ç›®å½•<code>dist</code>ï¼Œç„¶åä½ å¯ä»¥æ–°å»º<code>bin/mini-vite</code>æ–‡ä»¶æ¥å¼•ç”¨äº§ç‰©:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token hashbang comment">#!/usr/bin/env node</span>

<span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">&quot;../dist/index.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŒæ—¶ï¼Œä½ éœ€è¦åœ¨ package.json ä¸­æ³¨å†Œ<code>mini-vite</code>å‘½ä»¤ï¼Œé…ç½®å¦‚ä¸‹:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token punctuation">{</span>
  <span class="token string-property property">&quot;bin&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;mini-vite&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bin/mini-vite&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,15),d=s("code",null,"mini-vite",-1),v=s("code",null,"playground",-1),m={href:"https://github.com/sanyuan0704/juejin-book-vite/tree/main/mini-vite/playground",target:"_blank",rel:"noopener noreferrer"},b=a(`<p>å°† <code>playground</code> é¡¹ç›®æ”¾åœ¨ <code>mini-vite</code> ç›®å½•ä¸­ï¼Œç„¶åæ‰§è¡Œ <code>pnpm i</code>ï¼Œç”±äºé¡¹ç›®çš„<code>dependencies</code>ä¸­å·²ç»å£°æ˜äº†<code>mini-vite</code>:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token punctuation">{</span>
  <span class="token string-property property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;mini-vite&quot;</span><span class="token operator">:</span> <span class="token string">&#39;../&#39;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é‚£ä¹ˆ<code>mini-vite</code>å‘½ä»¤ä¼šè‡ªåŠ¨å®‰è£…åˆ°æµ‹è¯•é¡¹ç›®çš„<code>node_modules/.bin</code>ç›®å½•ä¸­:</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6fbe7e6ef1634e78803f28a6d1f90b7d~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><p>æ¥ç€æˆ‘ä»¬åœ¨<code>playground</code>é¡¹ç›®ä¸­æ‰§è¡Œ<code>pnpm dev</code>å‘½ä»¤(å†…éƒ¨æ‰§è¡Œ<code>mini-vite</code>)ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„ log ä¿¡æ¯:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>æµ‹è¯• cli~
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æ¥ç€ï¼Œæˆ‘ä»¬æŠŠ<code>console.log</code>è¯­å¥æ¢æˆæœåŠ¡å¯åŠ¨çš„é€»è¾‘:</p><div class="language-diff line-numbers-mode" data-ext="diff"><pre class="language-diff"><code>import cac from &quot;cac&quot;;
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> import { startDevServer } from &quot;./server&quot;;
</span></span>
const cli = cac();

cli
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> .command(&quot;[root]&quot;, &quot;Run the development server&quot;)
</span><span class="token prefix unchanged"> </span><span class="token line"> .alias(&quot;serve&quot;)
</span><span class="token prefix unchanged"> </span><span class="token line"> .alias(&quot;dev&quot;)
</span><span class="token prefix unchanged"> </span><span class="token line"> .action(async () =&gt; {
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">    console.log(&#39;æµ‹è¯• cli~&#39;);
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    await startDevServer();
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> });
</span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨ä½ éœ€è¦æ–°å»º<code>src/node/server/index.ts</code>ï¼Œå†…å®¹å¦‚ä¸‹:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// connect æ˜¯ä¸€ä¸ªå…·æœ‰ä¸­é—´ä»¶æœºåˆ¶çš„è½»é‡çº§ Node.js æ¡†æ¶ã€‚</span>
<span class="token comment">// æ—¢å¯ä»¥å•ç‹¬ä½œä¸ºæœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥æ¥å…¥åˆ°ä»»ä½•å…·æœ‰ä¸­é—´ä»¶æœºåˆ¶çš„æ¡†æ¶ä¸­ï¼Œå¦‚ Koaã€Express</span>
<span class="token keyword">import</span> connect <span class="token keyword">from</span> <span class="token string">&quot;connect&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// picocolors æ˜¯ä¸€ä¸ªç”¨æ¥åœ¨å‘½ä»¤è¡Œæ˜¾ç¤ºä¸åŒé¢œè‰²æ–‡æœ¬çš„å·¥å…·</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> blue<span class="token punctuation">,</span> green <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;picocolors&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">startDevServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> startTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
      <span class="token function">green</span><span class="token punctuation">(</span><span class="token string">&quot;ğŸš€ No-Bundle æœåŠ¡å·²ç»æˆåŠŸå¯åŠ¨!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">è€—æ—¶: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms</span><span class="token template-punctuation string">\`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&gt; æœ¬åœ°è®¿é—®è·¯å¾„: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token function">blue</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:3000&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å†æ¬¡æ‰§è¡Œ<code>pnpm dev</code>ï¼Œä½ å¯ä»¥å‘ç°ç»ˆç«¯å‡ºç°å¦‚ä¸‹çš„å¯åŠ¨æ—¥å¿—:</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/49e6e563b19041acab43f5246e1b5209~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><p>OKï¼Œ<code>mini-vite</code> çš„ cli åŠŸèƒ½å’ŒæœåŠ¡å¯åŠ¨çš„é€»è¾‘ç›®å‰å°±å·²ç»æˆåŠŸæ­å»ºèµ·æ¥äº†ã€‚</p><h2 id="ä¾èµ–é¢„æ„å»º" tabindex="-1"><a class="header-anchor" href="#ä¾èµ–é¢„æ„å»º" aria-hidden="true">#</a> ä¾èµ–é¢„æ„å»º</h2><p>ç°åœ¨æˆ‘ä»¬æ¥è¿›å…¥ä¾èµ–é¢„æ„å»ºé˜¶æ®µçš„å¼€å‘ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬æ–°å»º<code>src/node/optimizer/index.ts</code>æ¥å­˜æ”¾ä¾èµ–é¢„æ„å»ºçš„é€»è¾‘:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">optimize</span><span class="token punctuation">(</span>root<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. ç¡®å®šå…¥å£</span>
  <span class="token comment">// 2. ä»å…¥å£å¤„æ‰«æä¾èµ–</span>
  <span class="token comment">// 3. é¢„æ„å»ºä¾èµ–</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶ååœ¨æœåŠ¡å…¥å£ä¸­å¼•å…¥é¢„æ„å»ºçš„é€»è¾‘:</p><div class="language-diff line-numbers-mode" data-ext="diff"><pre class="language-diff"><code>// src/node/server/index.ts
import connect from &quot;connect&quot;;
import { blue, green } from &quot;picocolors&quot;;
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> import { optimize } from &quot;../optimizer/index&quot;;
</span></span>
export async function startDevServer() {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const app = connect();
</span><span class="token prefix unchanged"> </span><span class="token line"> const root = process.cwd();
</span><span class="token prefix unchanged"> </span><span class="token line"> const startTime = Date.now();
</span><span class="token prefix unchanged"> </span><span class="token line"> app.listen(3000, async () =&gt; {
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   await optimize(root);
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   console.log(
</span><span class="token prefix unchanged"> </span><span class="token line">     green(&quot;ğŸš€ No-Bundle æœåŠ¡å·²ç»æˆåŠŸå¯åŠ¨!&quot;),
</span><span class="token prefix unchanged"> </span><span class="token line">     \`è€—æ—¶: \${Date.now() - startTime}ms\`
</span><span class="token prefix unchanged"> </span><span class="token line">   );
</span><span class="token prefix unchanged"> </span><span class="token line">   console.log(\`&gt; æœ¬åœ°è®¿é—®è·¯å¾„: \${blue(&quot;http://localhost:3000&quot;)}\`);
</span><span class="token prefix unchanged"> </span><span class="token line"> });
</span></span>}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ç€æˆ‘ä»¬æ¥å¼€å‘ä¾èµ–é¢„æ„å»ºçš„åŠŸèƒ½ï¼Œä»ä¸Šé¢çš„ä»£ç æ³¨é‡Šä½ ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬éœ€è¦å®Œæˆä¸‰éƒ¨åˆ†çš„é€»è¾‘:</p><ul><li>ç¡®å®šé¢„æ„å»ºå…¥å£</li><li>ä»å…¥å£å¼€å§‹æ‰«æå‡ºç”¨åˆ°çš„ä¾èµ–</li><li>å¯¹ä¾èµ–è¿›è¡Œé¢„æ„å»º</li></ul><p>é¦–å…ˆæ˜¯ç¡®å®šå…¥å£ï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œè¿™é‡Œæˆ‘ç›´æ¥çº¦å®šä¸º src ç›®å½•ä¸‹çš„<code>main.tsx</code>æ–‡ä»¶:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// éœ€è¦å¼•å…¥çš„ä¾èµ–</span>
<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 1. ç¡®å®šå…¥å£</span>
<span class="token keyword">const</span> entry <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">&quot;src/main.tsx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¬¬äºŒæ­¥æ˜¯æ‰«æä¾èµ–:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// éœ€è¦å¼•å…¥çš„ä¾èµ– </span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> build <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;esbuild&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> green <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;picocolors&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> scanPlugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./scanPlugin&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 2. ä»å…¥å£å¤„æ‰«æä¾èµ–</span>
<span class="token keyword">const</span> deps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  entryPoints<span class="token operator">:</span> <span class="token punctuation">[</span>entry<span class="token punctuation">]</span><span class="token punctuation">,</span>
  bundle<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  write<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">scanPlugin</span><span class="token punctuation">(</span>deps<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
<span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token function">green</span><span class="token punctuation">(</span><span class="token string">&quot;éœ€è¦é¢„æ„å»ºçš„ä¾èµ–&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:\\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token punctuation">[</span><span class="token operator">...</span>deps<span class="token punctuation">]</span>
  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>green<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>item<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¾èµ–æ‰«æéœ€è¦æˆ‘ä»¬å€ŸåŠ© Esbuild æ’ä»¶æ¥å®Œæˆï¼Œæœ€åä¼šè®°å½•åˆ° deps è¿™ä¸ªé›†åˆä¸­ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ç€çœ¼äº Esbuild ä¾èµ–æ‰«ææ’ä»¶çš„å¼€å‘ï¼Œä½ éœ€è¦åœ¨<code>optimzier</code>ç›®å½•ä¸­æ–°å»º<code>scanPlguin.ts</code>æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/node/optimizer/scanPlugin.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Plugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;esbuild&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">BARE_IMPORT_RE</span><span class="token punctuation">,</span> <span class="token constant">EXTERNAL_TYPES</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../constants&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">scanPlugin</span><span class="token punctuation">(</span>deps<span class="token operator">:</span> Set<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> Plugin <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;esbuild:scan-deps&quot;</span><span class="token punctuation">,</span>
    <span class="token function">setup</span><span class="token punctuation">(</span>build<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¿½ç•¥çš„æ–‡ä»¶ç±»å‹</span>
      build<span class="token punctuation">.</span><span class="token function">onResolve</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span> filter<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">\\\\.(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">EXTERNAL_TYPES</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;|&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)$</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>resolveInfo<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">{</span>
            path<span class="token operator">:</span> resolveInfo<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
            <span class="token comment">// æ‰“ä¸Š external æ ‡è®°</span>
            external<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// è®°å½•ä¾èµ–</span>
      build<span class="token punctuation">.</span><span class="token function">onResolve</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
          filter<span class="token operator">:</span> <span class="token constant">BARE_IMPORT_RE</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>resolveInfo<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token operator">:</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> resolveInfo<span class="token punctuation">;</span>
          <span class="token comment">// æ¨å…¥ deps é›†åˆä¸­</span>
          deps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token punctuation">{</span>
            path<span class="token operator">:</span> id<span class="token punctuation">,</span>
            external<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œæ–‡ä»¶ä¸­ç”¨åˆ°äº†ä¸€äº›å¸¸é‡ï¼Œåœ¨<code>src/node/constants.ts</code>ä¸­å®šä¹‰ï¼Œå†…å®¹å¦‚ä¸‹:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">EXTERNAL_TYPES</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">&quot;css&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;less&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;sass&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;scss&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;styl&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;stylus&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;pcss&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;postcss&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;vue&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;svelte&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;marko&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;astro&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;png&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;jpe?g&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;gif&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;svg&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;ico&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;webp&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;avif&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">BARE_IMPORT_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[\\w@][^:]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ’ä»¶çš„é€»è¾‘éå¸¸ç®€å•ï¼Œå³æŠŠä¸€äº›æ— å…³çš„èµ„æºè¿›è¡Œ externalï¼Œä¸è®© esbuild å¤„ç†ï¼Œé˜²æ­¢ Esbuild æŠ¥é”™ï¼ŒåŒæ—¶å°†<code>bare import</code>çš„è·¯å¾„è§†ä½œç¬¬ä¸‰æ–¹åŒ…ï¼Œæ¨å…¥ deps é›†åˆä¸­ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬åœ¨<code>playground</code>é¡¹ç›®æ ¹è·¯å¾„ä¸­æ‰§è¡Œ<code>pnpm dev</code>ï¼Œå¯ä»¥å‘ç°ä¾èµ–æ‰«æå·²ç»æˆåŠŸæ‰§è¡Œ:</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0a870441e5f3431c94cb5789a92791df~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><p>å½“æˆ‘ä»¬æ”¶é›†åˆ°æ‰€æœ‰çš„ä¾èµ–ä¿¡æ¯ä¹‹åï¼Œå°±å¯ä»¥å¯¹æ¯ä¸ªä¾èµ–è¿›è¡Œæ‰“åŒ…ï¼Œå®Œæˆä¾èµ–é¢„æ„å»ºäº†:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/node/optimizer/index.ts</span>
<span class="token comment">// éœ€è¦å¼•å…¥çš„ä¾èµ–</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> preBundlePlugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./preBundlePlugin&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">PRE_BUNDLE_DIR</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../constants&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 3. é¢„æ„å»ºä¾èµ–</span>
<span class="token keyword">await</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  entryPoints<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>deps<span class="token punctuation">]</span><span class="token punctuation">,</span>
  write<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  bundle<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  format<span class="token operator">:</span> <span class="token string">&quot;esm&quot;</span><span class="token punctuation">,</span>
  splitting<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  outdir<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token constant">PRE_BUNDLE_DIR</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">preBundlePlugin</span><span class="token punctuation">(</span>deps<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨æ­¤ï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¸€ä¸ªæ–°çš„å¸¸é‡<code>PRE_BUNDLE_DIR</code>ï¼Œå®šä¹‰å¦‚ä¸‹:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/node/constants.ts</span>
<span class="token comment">// å¢åŠ å¦‚ä¸‹ä»£ç </span>
<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// é¢„æ„å»ºäº§ç‰©é»˜è®¤å­˜æ”¾åœ¨ node_modules ä¸­çš„ .m-vite ç›®å½•ä¸­</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">PRE_BUNDLE_DIR</span> <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;node_modules&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.m-vite&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ç€ï¼Œæˆ‘ä»¬ç»§ç»­å¼€å‘é¢„æ„å»ºçš„ Esbuild æ’ä»¶ã€‚é¦–å…ˆï¼Œè€ƒè™‘åˆ°å…¼å®¹ Windows ç³»ç»Ÿï¼Œæˆ‘ä»¬å…ˆåŠ å…¥ä¸€æ®µå·¥å…·å‡½æ•°çš„ä»£ç :</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/node/utils.ts</span>
<span class="token keyword">import</span> os <span class="token keyword">from</span> <span class="token string">&quot;os&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">slash</span><span class="token punctuation">(</span>p<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\\\</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> isWindows <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">platform</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;win32&quot;</span><span class="token punctuation">;</span>


<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span>isWindows <span class="token operator">?</span> <span class="token function">slash</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">:</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åå®Œå–„é¢„æ„å»ºçš„ä»£ç :</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Loader<span class="token punctuation">,</span> Plugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;esbuild&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">BARE_IMPORT_RE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../constants&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// ç”¨æ¥åˆ†æ es æ¨¡å— import/export è¯­å¥çš„åº“</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> init<span class="token punctuation">,</span> parse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;es-module-lexer&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// ä¸€ä¸ªå®ç°äº† node è·¯å¾„è§£æç®—æ³•çš„åº“</span>
<span class="token keyword">import</span> resolve <span class="token keyword">from</span> <span class="token string">&quot;resolve&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// ä¸€ä¸ªæ›´åŠ å¥½ç”¨çš„æ–‡ä»¶æ“ä½œåº“</span>
<span class="token keyword">import</span> fs <span class="token keyword">from</span> <span class="token string">&quot;fs-extra&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// ç”¨æ¥å¼€å‘æ‰“å° debug æ—¥å¿—çš„åº“</span>
<span class="token keyword">import</span> createDebug <span class="token keyword">from</span> <span class="token string">&quot;debug&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> normalizePath <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../utils&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> debug <span class="token operator">=</span> <span class="token function">createDebug</span><span class="token punctuation">(</span><span class="token string">&quot;dev&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">preBundlePlugin</span><span class="token punctuation">(</span>deps<span class="token operator">:</span> Set<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> Plugin <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;esbuild:pre-bundle&quot;</span><span class="token punctuation">,</span>
    <span class="token function">setup</span><span class="token punctuation">(</span>build<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      build<span class="token punctuation">.</span><span class="token function">onResolve</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
          filter<span class="token operator">:</span> <span class="token constant">BARE_IMPORT_RE</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>resolveInfo<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token operator">:</span> id<span class="token punctuation">,</span> importer <span class="token punctuation">}</span> <span class="token operator">=</span> resolveInfo<span class="token punctuation">;</span>
          <span class="token keyword">const</span> isEntry <span class="token operator">=</span> <span class="token operator">!</span>importer<span class="token punctuation">;</span>
          <span class="token comment">// å‘½ä¸­éœ€è¦é¢„ç¼–è¯‘çš„ä¾èµ–</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>deps<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è‹¥ä¸ºå…¥å£ï¼Œåˆ™æ ‡è®° dep çš„ namespace</span>
            <span class="token keyword">return</span> isEntry
              <span class="token operator">?</span> <span class="token punctuation">{</span>
                  path<span class="token operator">:</span> id<span class="token punctuation">,</span>
                  namespace<span class="token operator">:</span> <span class="token string">&quot;dep&quot;</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
              <span class="token operator">:</span> <span class="token punctuation">{</span>
                  <span class="token comment">// å› ä¸ºèµ°åˆ° onResolve äº†ï¼Œæ‰€ä»¥è¿™é‡Œçš„ path å°±æ˜¯ç»å¯¹è·¯å¾„äº†</span>
                  path<span class="token operator">:</span> resolve<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span> basedir<span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// æ‹¿åˆ°æ ‡è®°åçš„ä¾èµ–ï¼Œæ„é€ ä»£ç†æ¨¡å—ï¼Œäº¤ç»™ esbuild æ‰“åŒ…</span>
      build<span class="token punctuation">.</span><span class="token function">onLoad</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
          filter<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
          namespace<span class="token operator">:</span> <span class="token string">&quot;dep&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">async</span> <span class="token punctuation">(</span>loadInfo<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">await</span> init<span class="token punctuation">;</span>
          <span class="token keyword">const</span> id <span class="token operator">=</span> loadInfo<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
          <span class="token keyword">const</span> root <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> entryPath <span class="token operator">=</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>resolve<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span> basedir<span class="token operator">:</span> root <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>entryPath<span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> <span class="token punctuation">[</span>imports<span class="token punctuation">,</span> exports<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> proxyModule <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token comment">// cjs</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>imports<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>exports<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ„é€ ä»£ç†æ¨¡å—</span>
            <span class="token comment">// ä¸‹é¢çš„ä»£ç åé¢ä¼šè§£é‡Š</span>
            <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span>entryPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> specifiers <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            proxyModule<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
              <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">export { </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>specifiers<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> } from &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>entryPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>
              <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">export default require(&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>entryPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;)</span><span class="token template-punctuation string">\`</span></span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// esm æ ¼å¼æ¯”è¾ƒå¥½å¤„ç†ï¼Œexport * æˆ–è€… export default å³å¯</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>exports<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              proxyModule<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">import d from &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>entryPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;;export default d</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            proxyModule<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">export * from &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>entryPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;ä»£ç†æ¨¡å—å†…å®¹: %o&quot;</span><span class="token punctuation">,</span> proxyModule<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> loader <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>entryPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token punctuation">{</span>
            loader<span class="token operator">:</span> loader <span class="token keyword">as</span> Loader<span class="token punctuation">,</span>
            contents<span class="token operator">:</span> proxyModule<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            resolveDir<span class="token operator">:</span> root<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œå¯¹äº CommonJS æ ¼å¼çš„ä¾èµ–ï¼Œå•çº¯ç”¨ <code>export default require(&#39;å…¥å£è·¯å¾„&#39;)</code> æ˜¯æœ‰å±€é™æ€§çš„ï¼Œæ¯”å¦‚å¯¹äº React è€Œè¨€ï¼Œç”¨è¿™æ ·çš„æ–¹å¼ç”Ÿæˆçš„äº§ç‰©æœ€ååªæœ‰ default å¯¼å‡º:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// esbuild çš„æ‰“åŒ…äº§ç‰©</span>
<span class="token comment">// çœç•¥å¤§éƒ¨åˆ†ä»£ç </span>
<span class="token keyword">export</span> <span class="token keyword">default</span> react_default<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é‚£ä¹ˆç”¨æˆ·åœ¨ä½¿ç”¨è¿™ä¸ªä¾èµ–çš„æ—¶å€™ï¼Œå¿…é¡»è¿™ä¹ˆä½¿ç”¨:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// âœ… æ­£ç¡®</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token operator">=</span> React<span class="token punctuation">;</span>

<span class="token comment">// âŒ æŠ¥é”™</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é‚£ä¸ºä»€ä¹ˆä¸Šè¿°ä¼šæŠ¥é”™çš„è¯­æ³•åœ¨ Vite æ˜¯å¯ä»¥æ­£å¸¸ä½¿ç”¨çš„å‘¢ï¼ŸåŸå› æ˜¯ Vite åœ¨åš import è¯­å¥åˆ†æçš„æ—¶å€™ï¼Œè‡ªåŠ¨å°†ä½ çš„ä»£ç è¿›è¡Œæ”¹å†™äº†:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// åŸæ¥çš„å†™æ³•</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span><span class="token punctuation">;</span>

<span class="token comment">// Vite çš„ importAnalysis æ’ä»¶è½¬æ¢åçš„å†™æ³•ç±»ä¼¼ä¸‹é¢è¿™æ ·</span>
<span class="token keyword">import</span> react_default <span class="token keyword">from</span> <span class="token string">&#39;/node_modules/.vite/react.js&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token operator">=</span> react_default<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é‚£ä¹ˆï¼Œè¿˜æœ‰æ²¡æœ‰åˆ«çš„æ–¹æ¡ˆæ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿæ²¡é”™ï¼Œä¸Šè¿°çš„æ’ä»¶ä»£ç ä¸­å·²ç»ç”¨å¦ä¸€ä¸ªæ–¹æ¡ˆè§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¸å¦¨æŠŠç›®å…‰é›†ä¸­åœ¨ä¸‹é¢è¿™æ®µä»£ç ä¸­:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>imports<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>exports<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ„é€ ä»£ç†æ¨¡å—</span>
    <span class="token comment">// é€šè¿‡ require æ‹¿åˆ°æ¨¡å—çš„å¯¼å‡ºå¯¹è±¡</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span>entryPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ç”¨ Object.keys æ‹¿åˆ°æ‰€æœ‰çš„å…·åå¯¼å‡º</span>
    <span class="token keyword">const</span> specifiers <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ„é€  export è¯­å¥äº¤ç»™ Esbuild æ‰“åŒ…</span>
    proxyModule<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">export { </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>specifiers<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> } from &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>entryPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">export default require(&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>entryPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;)</span><span class="token template-punctuation string">\`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æ­¤ä¸€æ¥ï¼ŒEsbuild é¢„æ„å»ºçš„äº§ç‰©ä¸­ä¾¿ä¼šåŒ…å« CommonJS æ¨¡å—ä¸­æ‰€æœ‰çš„å¯¼å‡ºä¿¡æ¯:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// é¢„æ„å»ºäº§ç‰©å¯¼å‡ºä»£ç </span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>
  react_default <span class="token keyword">as</span> <span class="token keyword">default</span><span class="token punctuation">,</span>
  useState<span class="token punctuation">,</span>
  useEffect<span class="token punctuation">,</span>
  <span class="token comment">// çœç•¥å…¶å®ƒå¯¼å‡º</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>OKï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹é¢„æ„å»ºæ•´ä½“çš„åŠŸèƒ½ã€‚åœ¨ <code>playground</code> é¡¹ç›®ä¸­æ‰§è¡Œ <code>pnpm dev</code>ï¼Œæ¥ç€å»é¡¹ç›®çš„ <code>node_modules</code> ç›®å½•ä¸­ï¼Œå¯ä»¥å‘ç°æ–°å¢äº†<code>.m-vite</code> ç›®å½•åŠ<code>react</code>ã€<code>react-dom</code>çš„é¢„æ„å»ºäº§ç‰©:</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c4a1fbb12ead4bb4a7b5b75001949da6~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><h2 id="æ’ä»¶æœºåˆ¶å¼€å‘" tabindex="-1"><a class="header-anchor" href="#æ’ä»¶æœºåˆ¶å¼€å‘" aria-hidden="true">#</a> æ’ä»¶æœºåˆ¶å¼€å‘</h2><p>åœ¨å®Œæˆäº†ä¾èµ–é¢„æ„å»ºçš„åŠŸèƒ½ä¹‹åï¼Œæˆ‘ä»¬å¼€å§‹æ­å»º Vite çš„æ’ä»¶æœºåˆ¶ï¼Œå®ç°æ’ä»¶å®¹å™¨å’Œæ’ä»¶ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚</p><p>é¦–å…ˆï¼Œä½ å¯ä»¥æ–°å»º<code>src/node/pluginContainer.ts</code>æ–‡ä»¶ï¼Œå¢åŠ å¦‚ä¸‹çš„ç±»å‹å®šä¹‰:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span>
  LoadResult<span class="token punctuation">,</span>
  PartialResolvedId<span class="token punctuation">,</span>
  SourceDescription<span class="token punctuation">,</span>
  PluginContext <span class="token keyword">as</span> RollupPluginContext<span class="token punctuation">,</span>
  ResolvedId<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;rollup&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">PluginContainer</span> <span class="token punctuation">{</span>
  <span class="token function">resolveId</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> importer<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>PartialResolvedId <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token function">load</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>LoadResult <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token function">transform</span><span class="token punctuation">(</span>code<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>SourceDescription <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦å¤–ï¼Œç”±äºæ’ä»¶å®¹å™¨éœ€è¦æ¥æ”¶ Vite æ’ä»¶ä½œä¸ºåˆå§‹åŒ–å‚æ•°ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æå‰å£°æ˜æ’ä»¶çš„ç±»å‹ï¼Œä½ å¯ä»¥ç»§ç»­æ–°å»º<code>src/node/plugin.ts</code>æ¥å£°æ˜å¦‚ä¸‹çš„æ’ä»¶ç±»å‹:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> LoadResult<span class="token punctuation">,</span> PartialResolvedId<span class="token punctuation">,</span> SourceDescription <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;rollup&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ServerContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./server&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">ServerHook</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  server<span class="token operator">:</span> ServerContext
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token operator">|</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">void</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token comment">// åªå®ç°ä»¥ä¸‹è¿™å‡ ä¸ªé’©å­</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Plugin</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  configureServer<span class="token operator">?</span><span class="token operator">:</span> ServerHook<span class="token punctuation">;</span>
  resolveId<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>
    id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    importer<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>PartialResolvedId <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span> <span class="token operator">|</span> PartialResolvedId <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  load<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>LoadResult <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span> <span class="token operator">|</span> LoadResult <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  transform<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>
    code<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    id<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>SourceDescription <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span> <span class="token operator">|</span> SourceDescription <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  transformIndexHtml<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>raw<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹äºå…¶ä¸­çš„ ServerContextï¼Œä½ æš‚æ—¶ä¸ç”¨è¿‡äºå…³å¿ƒï¼Œåªéœ€è¦åœ¨<code>server/index.ts</code>ä¸­ç®€å•å£°æ˜ä¸€ä¸‹ç±»å‹å³å¯:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/node/server/index.ts</span>
<span class="token comment">// å¢åŠ å¦‚ä¸‹ç±»å‹å£°æ˜</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ServerContext</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ç€ï¼Œæˆ‘ä»¬æ¥å®ç°æ’ä»¶æœºåˆ¶çš„å…·ä½“é€»è¾‘ï¼Œä¸»è¦é›†ä¸­åœ¨<code>createPluginContainer</code>å‡½æ•°ä¸­:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/node/pluginContainer.ts</span>
<span class="token comment">// æ¨¡æ‹Ÿ Rollup çš„æ’ä»¶æœºåˆ¶</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> createPluginContainer <span class="token operator">=</span> <span class="token punctuation">(</span>plugins<span class="token operator">:</span> Plugin<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> PluginContainer <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// æ’ä»¶ä¸Šä¸‹æ–‡å¯¹è±¡</span>
  <span class="token comment">// @ts-ignore è¿™é‡Œä»…å®ç°ä¸Šä¸‹æ–‡å¯¹è±¡çš„ resolve æ–¹æ³•</span>
  <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token keyword">implements</span> <span class="token class-name">RollupPluginContext</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token function">resolve</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> importer<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> out <span class="token operator">=</span> <span class="token keyword">await</span> pluginContainer<span class="token punctuation">.</span><span class="token function">resolveId</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> importer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> out <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> out <span class="token operator">=</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> out <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> out <span class="token keyword">as</span> ResolvedId <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// æ’ä»¶å®¹å™¨</span>
  <span class="token keyword">const</span> pluginContainer<span class="token operator">:</span> PluginContainer <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token function">resolveId</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> importer<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> plugin <span class="token keyword">of</span> plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>plugin<span class="token punctuation">.</span>resolveId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> newId <span class="token operator">=</span> <span class="token keyword">await</span> plugin<span class="token punctuation">.</span><span class="token function">resolveId</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>ctx <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> importer<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>newId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            id <span class="token operator">=</span> <span class="token keyword">typeof</span> newId <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span> <span class="token operator">?</span> newId <span class="token operator">:</span> newId<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">load</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> plugin <span class="token keyword">of</span> plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>plugin<span class="token punctuation">.</span>load<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> plugin<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">transform</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> plugin <span class="token keyword">of</span> plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>plugin<span class="token punctuation">.</span>transform<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> plugin<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> code<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> result <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            code <span class="token operator">=</span> result<span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            code <span class="token operator">=</span> result<span class="token punctuation">.</span>code<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> pluginContainer<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œå¹¶ä¸”å…³äºæ’ä»¶é’©å­çš„æ‰§è¡ŒåŸç†å’Œæ’ä»¶ä¸Šä¸‹æ–‡å¯¹è±¡çš„ä½œç”¨ï¼Œåœ¨å°å†Œç¬¬ 22 èŠ‚ä¸­ä¹Ÿæœ‰è¯¦ç»†çš„åˆ†æï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ã€‚</p><p>æ¥ç€ï¼Œæˆ‘ä»¬æ¥å®Œå–„ä¸€ä¸‹ä¹‹å‰çš„æœåŠ¡å™¨é€»è¾‘:</p><div class="language-diff line-numbers-mode" data-ext="diff"><pre class="language-diff"><code>// src/node/server/index.ts
import connect from &quot;connect&quot;;
import { blue, green } from &quot;picocolors&quot;;
import { optimize } from &quot;../optimizer/index&quot;;
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> import { resolvePlugins } from &quot;../plugins&quot;;
</span><span class="token prefix inserted">+</span><span class="token line"> import { createPluginContainer, PluginContainer } from &quot;../pluginContainer&quot;;
</span></span>
export interface ServerContext {
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  root: string;
</span><span class="token prefix inserted">+</span><span class="token line">  pluginContainer: PluginContainer;
</span><span class="token prefix inserted">+</span><span class="token line">  app: connect.Server;
</span><span class="token prefix inserted">+</span><span class="token line">  plugins: Plugin[];
</span></span>}

export async function startDevServer() {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> const app = connect();
</span><span class="token prefix unchanged"> </span><span class="token line"> const root = process.cwd();
</span><span class="token prefix unchanged"> </span><span class="token line"> const startTime = Date.now();
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  const plugins = resolvePlugins();
</span><span class="token prefix inserted">+</span><span class="token line">  const pluginContainer = createPluginContainer(plugins);
</span></span>
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  const serverContext: ServerContext = {
</span><span class="token prefix inserted">+</span><span class="token line">    root: process.cwd(),
</span><span class="token prefix inserted">+</span><span class="token line">    app,
</span><span class="token prefix inserted">+</span><span class="token line">    pluginContainer,
</span><span class="token prefix inserted">+</span><span class="token line">    plugins,
</span><span class="token prefix inserted">+</span><span class="token line">  };
</span></span>
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  for (const plugin of plugins) {
</span><span class="token prefix inserted">+</span><span class="token line">    if (plugin.configureServer) {
</span><span class="token prefix inserted">+</span><span class="token line">      await plugin.configureServer(serverContext);
</span><span class="token prefix inserted">+</span><span class="token line">    }
</span><span class="token prefix inserted">+</span><span class="token line">  }
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> app.listen(3000, async () =&gt; {
</span><span class="token prefix unchanged"> </span><span class="token line">   await optimize(root);
</span><span class="token prefix unchanged"> </span><span class="token line">   console.log(
</span><span class="token prefix unchanged"> </span><span class="token line">     green(&quot;ğŸš€ No-Bundle æœåŠ¡å·²ç»æˆåŠŸå¯åŠ¨!&quot;),
</span><span class="token prefix unchanged"> </span><span class="token line">     \`è€—æ—¶: \${Date.now() - startTime}ms\`
</span><span class="token prefix unchanged"> </span><span class="token line">   );
</span><span class="token prefix unchanged"> </span><span class="token line">   console.log(\`&gt; æœ¬åœ°è®¿é—®è·¯å¾„: \${blue(&quot;http://localhost:3000&quot;)}\`);
</span><span class="token prefix unchanged"> </span><span class="token line"> });
</span></span>}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä¸­ <code>resolvePlugins</code> æ–¹æ³•æˆ‘ä»¬è¿˜æœªå®šä¹‰ï¼Œä½ å¯ä»¥æ–°å»º<code>src/node/plugins/index.ts</code> æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Plugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../plugin&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">resolvePlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Plugin<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token comment">// ä¸‹ä¸€éƒ¨åˆ†ä¼šé€ä¸ªè¡¥å……æ’ä»¶é€»è¾‘</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="å…¥å£-html-åŠ è½½" tabindex="-1"><a class="header-anchor" href="#å…¥å£-html-åŠ è½½" aria-hidden="true">#</a> å…¥å£ HTML åŠ è½½</h2><p>ç°åœ¨æˆ‘ä»¬åŸºäºå¦‚ä¸Šçš„æ’ä»¶æœºåˆ¶ï¼Œæ¥å®ç° Vite çš„æ ¸å¿ƒç¼–è¯‘èƒ½åŠ›ã€‚</p><p>é¦–å…ˆè¦è€ƒè™‘çš„å°±æ˜¯å…¥å£ HTML å¦‚ä½•ç¼–è¯‘å’ŒåŠ è½½çš„é—®é¢˜ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªæœåŠ¡ä¸­é—´ä»¶ï¼Œé…åˆæ’ä»¶æœºåˆ¶æ¥å®ç°ã€‚å…·ä½“è€Œè¨€ï¼Œä½ å¯ä»¥æ–°å»º<code>src/node/server/middlewares/indexHtml.ts</code>ï¼Œå†…å®¹å¦‚ä¸‹:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> NextHandleFunction <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;connect&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ServerContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../index&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> pathExists<span class="token punctuation">,</span> readFile <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;fs-extra&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">indexHtmlMiddware</span><span class="token punctuation">(</span>
  serverContext<span class="token operator">:</span> ServerContext
<span class="token punctuation">)</span><span class="token operator">:</span> NextHandleFunction <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> root <span class="token punctuation">}</span> <span class="token operator">=</span> serverContext<span class="token punctuation">;</span>
      <span class="token comment">// é»˜è®¤ä½¿ç”¨é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ index.html</span>
      <span class="token keyword">const</span> indexHtmlPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">&quot;index.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">pathExists</span><span class="token punctuation">(</span>indexHtmlPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> rawHtml <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readFile</span><span class="token punctuation">(</span>indexHtmlPath<span class="token punctuation">,</span> <span class="token string">&quot;utf8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> html <span class="token operator">=</span> rawHtml<span class="token punctuation">;</span>
        <span class="token comment">// é€šè¿‡æ‰§è¡Œæ’ä»¶çš„ transformIndexHtml æ–¹æ³•æ¥å¯¹ HTML è¿›è¡Œè‡ªå®šä¹‰çš„ä¿®æ”¹</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> plugin <span class="token keyword">of</span> serverContext<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>plugin<span class="token punctuation">.</span>transformIndexHtml<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            html <span class="token operator">=</span> <span class="token keyword">await</span> plugin<span class="token punctuation">.</span><span class="token function">transformIndexHtml</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;text/html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶ååœ¨æœåŠ¡ä¸­åº”ç”¨è¿™ä¸ªä¸­é—´ä»¶:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/node/server/index.ts</span>
<span class="token comment">// éœ€è¦å¢åŠ çš„å¼•å…¥è¯­å¥</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> indexHtmlMiddware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./middlewares/indexHtml&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// çœç•¥ä¸­é—´çš„ä»£ç </span>

<span class="token comment">// å¤„ç†å…¥å£ HTML èµ„æº</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">indexHtmlMiddware</span><span class="token punctuation">(</span>serverContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// çœç•¥</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥é€šè¿‡<code>pnpm dev</code>å¯åŠ¨é¡¹ç›®ï¼Œç„¶åè®¿é—®<code>http://localhost:3000</code>ï¼Œä»ç½‘ç»œé¢æ¿ä¸­ä½ å¯ä»¥æŸ¥çœ‹åˆ° HTML çš„å†…å®¹å·²ç»æˆåŠŸè¿”å›:</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/24a244087a64467abcb94ae4ddd70c3e~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><p>ä¸è¿‡å½“å‰çš„é¡µé¢å¹¶æ²¡æœ‰ä»»ä½•å†…å®¹ï¼Œå› ä¸º HTML ä¸­å¼•å…¥çš„ TSX æ–‡ä»¶å¹¶æ²¡æœ‰è¢«æ­£ç¡®ç¼–è¯‘ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥å¤„ç† TSX æ–‡ä»¶çš„ç¼–è¯‘å·¥ä½œã€‚</p><h2 id="js-ts-jsx-tsx-ç¼–è¯‘èƒ½åŠ›" tabindex="-1"><a class="header-anchor" href="#js-ts-jsx-tsx-ç¼–è¯‘èƒ½åŠ›" aria-hidden="true">#</a> JS/TS/JSX/TSX ç¼–è¯‘èƒ½åŠ›</h2><p>é¦–å…ˆæ–°å¢ä¸€ä¸ªä¸­é—´ä»¶<code>src/node/server/middlewares/transform.ts</code>ï¼Œå†…å®¹å¦‚ä¸‹:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> NextHandleFunction <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;connect&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  isJSRequest<span class="token punctuation">,</span>
  cleanUrl<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../../utils&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ServerContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../index&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> createDebug <span class="token keyword">from</span> <span class="token string">&quot;debug&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> debug <span class="token operator">=</span> <span class="token function">createDebug</span><span class="token punctuation">(</span><span class="token string">&quot;dev&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">transformRequest</span><span class="token punctuation">(</span>
  url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  serverContext<span class="token operator">:</span> ServerContext
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> pluginContainer <span class="token punctuation">}</span> <span class="token operator">=</span> serverContext<span class="token punctuation">;</span>
  url <span class="token operator">=</span> <span class="token function">cleanUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¾æ¬¡è°ƒç”¨æ’ä»¶å®¹å™¨çš„ resolveIdã€loadã€transform æ–¹æ³•</span>
  <span class="token keyword">const</span> resolvedResult <span class="token operator">=</span> <span class="token keyword">await</span> pluginContainer<span class="token punctuation">.</span><span class="token function">resolveId</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> transformResult<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedResult<span class="token operator">?.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token keyword">await</span> pluginContainer<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>resolvedResult<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> code <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">&amp;&amp;</span> code <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      code <span class="token operator">=</span> code<span class="token punctuation">.</span>code<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      transformResult <span class="token operator">=</span> <span class="token keyword">await</span> pluginContainer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>
        code <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
        resolvedResult<span class="token operator">?.</span>id
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> transformResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">transformMiddleware</span><span class="token punctuation">(</span>
  serverContext<span class="token operator">:</span> ServerContext
<span class="token punctuation">)</span><span class="token operator">:</span> NextHandleFunction <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">&quot;GET&quot;</span> <span class="token operator">||</span> <span class="token operator">!</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;transformMiddleware: %s&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// transform JS request</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isJSRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ ¸å¿ƒç¼–è¯‘å‡½æ•°</span>
      <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">transformRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> serverContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> result <span class="token operator">!==</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> result<span class="token punctuation">.</span>code<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// ç¼–è¯‘å®Œæˆï¼Œè¿”å›å“åº”ç»™æµè§ˆå™¨</span>
      res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/javascript&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦è¡¥å……å¦‚ä¸‹çš„å·¥å…·å‡½æ•°å’Œå¸¸é‡å®šä¹‰:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/node/utils.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">JS_TYPES_RE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./constants.ts&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> isJSRequest <span class="token operator">=</span> <span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  id <span class="token operator">=</span> <span class="token function">cleanUrl</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">JS_TYPES_RE</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>id<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> cleanUrl <span class="token operator">=</span> <span class="token punctuation">(</span>url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=&gt;</span>
  url<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">HASH_RE</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">QEURY_RE</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token comment">// src/node/constants.ts</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">JS_TYPES_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\.(?:j|t)sx?$|\\.mjs$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">QEURY_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\?.*$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">s</span></span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">HASH_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">#.*$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">s</span></span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»å¦‚ä¸Šçš„æ ¸å¿ƒç¼–è¯‘å‡½æ•°<code>transformRequest</code>å¯ä»¥çœ‹å‡ºï¼ŒVite å¯¹äº JS/TS/JSX/TSX æ–‡ä»¶çš„ç¼–è¯‘æµç¨‹ä¸»è¦æ˜¯ä¾æ¬¡è°ƒç”¨æ’ä»¶å®¹å™¨çš„å¦‚ä¸‹æ–¹æ³•:</p><ul><li>resolveId</li><li>load</li><li>transform</li></ul><p>å…¶ä¸­ä¼šç»å†ä¼—å¤šæ’ä»¶çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆï¼Œå¯¹äº TSX æ–‡ä»¶çš„ç¼–è¯‘é€»è¾‘ï¼Œä¹Ÿåˆ†æ•£åˆ°äº†å„ä¸ªæ’ä»¶å½“ä¸­ï¼Œå…·ä½“æ¥è¯´ä¸»è¦åŒ…å«ä»¥ä¸‹çš„æ’ä»¶:</p><ul><li>è·¯å¾„è§£ææ’ä»¶</li><li>Esbuild è¯­æ³•ç¼–è¯‘æ’ä»¶</li><li>import åˆ†ææ’ä»¶</li></ul><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¼€å§‹ä¾æ¬¡å®ç°è¿™äº›æ’ä»¶ã€‚</p><h3 id="_1-è·¯å¾„è§£ææ’ä»¶" tabindex="-1"><a class="header-anchor" href="#_1-è·¯å¾„è§£ææ’ä»¶" aria-hidden="true">#</a> 1. è·¯å¾„è§£ææ’ä»¶</h3><p>å½“æµè§ˆå™¨è§£æåˆ°å¦‚ä¸‹çš„æ ‡ç­¾æ—¶:</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/src/main.tsx<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä¼šè‡ªåŠ¨å‘é€ä¸€ä¸ªè·¯å¾„ä¸º<code>/src/main.tsx</code>çš„è¯·æ±‚ï¼Œä½†å¦‚æœæœåŠ¡ç«¯ä¸åšä»»ä½•å¤„ç†ï¼Œæ˜¯æ— æ³•å®šä½åˆ°æºæ–‡ä»¶çš„ï¼Œéšä¹‹ä¼šè¿”å› 404 çŠ¶æ€ç :</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/13e2fee3e7a44950b2a1820576013d3a~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å¼€å‘ä¸€ä¸ªè·¯å¾„è§£ææ’ä»¶ï¼Œå¯¹è¯·æ±‚çš„è·¯å¾„è¿›è¡Œå¤„ç†ï¼Œä½¿ä¹‹èƒ½è½¬æ¢çœŸå®æ–‡ä»¶ç³»ç»Ÿä¸­çš„è·¯å¾„ã€‚ä½ å¯ä»¥æ–°å»ºæ–‡ä»¶<code>src/node/plugins/resolve.ts</code>ï¼Œå†…å®¹å¦‚ä¸‹:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> resolve <span class="token keyword">from</span> <span class="token string">&quot;resolve&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Plugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../plugin&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ServerContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../server/index&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> pathExists <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;fs-extra&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">DEFAULT_EXTERSIONS</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../constants&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> cleanUrl<span class="token punctuation">,</span> normalizePath <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../utils&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">resolvePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Plugin <span class="token punctuation">{</span>
  <span class="token keyword">let</span> serverContext<span class="token operator">:</span> ServerContext<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;m-vite:resolve&quot;</span><span class="token punctuation">,</span>
    <span class="token function">configureServer</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ä¿å­˜æœåŠ¡ç«¯ä¸Šä¸‹æ–‡</span>
      serverContext <span class="token operator">=</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">resolveId</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> importer<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1. ç»å¯¹è·¯å¾„</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">isAbsolute</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">pathExists</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// åŠ ä¸Š root è·¯å¾„å‰ç¼€ï¼Œå¤„ç† /src/main.tsx çš„æƒ…å†µ</span>
        id <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>serverContext<span class="token punctuation">.</span>root<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">pathExists</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 2. ç›¸å¯¹è·¯å¾„</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>importer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;\`importer\` should not be undefined&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> hasExtension <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> resolvedId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.1 åŒ…å«æ–‡ä»¶ååç¼€</span>
        <span class="token comment">// å¦‚ ./App.tsx</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasExtension<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          resolvedId <span class="token operator">=</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>resolve<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span> basedir<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>importer<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">pathExists</span><span class="token punctuation">(</span>resolvedId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> resolvedId <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> 
        <span class="token comment">// 2.2 ä¸åŒ…å«æ–‡ä»¶ååç¼€</span>
        <span class="token comment">// å¦‚ ./App</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// ./App -&gt; ./App.tsx</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> extname <span class="token keyword">of</span> <span class="token constant">DEFAULT_EXTERSIONS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token keyword">const</span> withExtension <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>extname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span>
              resolvedId <span class="token operator">=</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>resolve<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>withExtension<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                basedir<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>importer<span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">pathExists</span><span class="token punctuation">(</span>resolvedId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> resolvedId <span class="token punctuation">}</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ ·å¯¹äº <code>/src/main.tsx</code>ï¼Œåœ¨æ’ä»¶ä¸­ä¼šè½¬æ¢ä¸ºæ–‡ä»¶ç³»ç»Ÿä¸­çš„çœŸå®è·¯å¾„ï¼Œä»è€Œè®©æ¨¡å—åœ¨ load é’©å­ä¸­èƒ½å¤Ÿæ­£å¸¸åŠ è½½(åŠ è½½é€»è¾‘åœ¨ Esbuild è¯­æ³•ç¼–è¯‘æ’ä»¶å®ç°)ã€‚</p><p>æ¥ç€æˆ‘ä»¬æ¥è¡¥å……ä¸€ä¸‹ç›®å‰ç¼ºå°‘çš„å¸¸é‡:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/node/constants.ts</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">DEFAULT_EXTERSIONS</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;.tsx&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.ts&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.jsx&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;js&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-esbuild-è¯­æ³•ç¼–è¯‘æ’ä»¶" tabindex="-1"><a class="header-anchor" href="#_2-esbuild-è¯­æ³•ç¼–è¯‘æ’ä»¶" aria-hidden="true">#</a> 2. Esbuild è¯­æ³•ç¼–è¯‘æ’ä»¶</h3><p>è¿™ä¸ªæ’ä»¶çš„ä½œç”¨æ¯”è¾ƒå¥½ç†è§£ï¼Œå°±æ˜¯å°† JS/TS/JSX/TSX ç¼–è¯‘æˆæµè§ˆå™¨å¯ä»¥è¯†åˆ«çš„ JS è¯­æ³•ï¼Œå¯ä»¥åˆ©ç”¨ Esbuild çš„ Transform API æ¥å®ç°ã€‚ä½ å¯ä»¥æ–°å»º<code>src/node/plugins/esbuild.ts</code>æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> readFile <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;fs-extra&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Plugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../plugin&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> isJSRequest <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../utils&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> esbuild <span class="token keyword">from</span> <span class="token string">&quot;esbuild&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">esbuildTransformPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Plugin <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;m-vite:esbuild-transform&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// åŠ è½½æ¨¡å—</span>
    <span class="token keyword">async</span> <span class="token function">load</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isJSRequest</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readFile</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> code<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">transform</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isJSRequest</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> extname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> code<span class="token operator">:</span> transformedCode<span class="token punctuation">,</span> map <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> esbuild<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          target<span class="token operator">:</span> <span class="token string">&quot;esnext&quot;</span><span class="token punctuation">,</span>
          format<span class="token operator">:</span> <span class="token string">&quot;esm&quot;</span><span class="token punctuation">,</span>
          sourcemap<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          loader<span class="token operator">:</span> extname <span class="token keyword">as</span> <span class="token string">&quot;js&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;ts&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;jsx&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;tsx&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
          code<span class="token operator">:</span> transformedCode<span class="token punctuation">,</span>
          map<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-import-åˆ†ææ’ä»¶" tabindex="-1"><a class="header-anchor" href="#_3-import-åˆ†ææ’ä»¶" aria-hidden="true">#</a> 3. import åˆ†ææ’ä»¶</h3><p>åœ¨å°† TSX è½¬æ¢ä¸ºæµè§ˆå™¨å¯ä»¥è¯†åˆ«çš„è¯­æ³•ä¹‹åï¼Œæ˜¯ä¸æ˜¯å°±å¯ä»¥ç›´æ¥è¿”å›ç»™æµè§ˆå™¨æ‰§è¡Œäº†å‘¢ï¼Ÿ</p><p>æ˜¾ç„¶ä¸æ˜¯ï¼Œæˆ‘ä»¬è¿˜è€ƒè™‘å¦‚ä¸‹çš„ä¸€äº›é—®é¢˜:</p><ul><li>å¯¹äºç¬¬ä¸‰æ–¹ä¾èµ–è·¯å¾„(bare import)ï¼Œéœ€è¦é‡å†™ä¸ºé¢„æ„å»ºäº§ç‰©è·¯å¾„ï¼›</li><li>å¯¹äºç»å¯¹è·¯å¾„å’Œç›¸å¯¹è·¯å¾„ï¼Œéœ€è¦å€ŸåŠ©ä¹‹å‰çš„è·¯å¾„è§£ææ’ä»¶è¿›è¡Œè§£æã€‚</li></ul><p>å¥½ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±åœ¨ import åˆ†ææ’ä»¶ä¸­ä¸€ä¸€è§£å†³è¿™äº›é—®é¢˜:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// æ–°å»º src/node/plugins/importAnalysis.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> init<span class="token punctuation">,</span> parse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;es-module-lexer&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  <span class="token constant">BARE_IMPORT_RE</span><span class="token punctuation">,</span>
  <span class="token constant">DEFAULT_EXTERSIONS</span><span class="token punctuation">,</span>
  <span class="token constant">PRE_BUNDLE_DIR</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../constants&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  cleanUrl<span class="token punctuation">,</span>
  isJSRequest<span class="token punctuation">,</span>
  normalizePath
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../utils&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// magic-string ç”¨æ¥ä½œå­—ç¬¦ä¸²ç¼–è¾‘</span>
<span class="token keyword">import</span> MagicString <span class="token keyword">from</span> <span class="token string">&quot;magic-string&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Plugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../plugin&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ServerContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../server/index&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> pathExists <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;fs-extra&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> resolve <span class="token keyword">from</span> <span class="token string">&quot;resolve&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">importAnalysisPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Plugin <span class="token punctuation">{</span>
  <span class="token keyword">let</span> serverContext<span class="token operator">:</span> ServerContext<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;m-vite:import-analysis&quot;</span><span class="token punctuation">,</span>
    <span class="token function">configureServer</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ä¿å­˜æœåŠ¡ç«¯ä¸Šä¸‹æ–‡</span>
      serverContext <span class="token operator">=</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">transform</span><span class="token punctuation">(</span>code<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// åªå¤„ç† JS ç›¸å…³çš„è¯·æ±‚</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isJSRequest</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">await</span> init<span class="token punctuation">;</span>
      <span class="token comment">// è§£æ import è¯­å¥</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span>imports<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> ms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// å¯¹æ¯ä¸€ä¸ª import è¯­å¥ä¾æ¬¡è¿›è¡Œåˆ†æ</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> importInfo <span class="token keyword">of</span> imports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä¸¾ä¾‹è¯´æ˜: const str = \`import React from &#39;react&#39;\`</span>
        <span class="token comment">// str.slice(s, e) =&gt; &#39;react&#39;</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> s<span class="token operator">:</span> modStart<span class="token punctuation">,</span> e<span class="token operator">:</span> modEnd<span class="token punctuation">,</span> n<span class="token operator">:</span> modSource <span class="token punctuation">}</span> <span class="token operator">=</span> importInfo<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>modSource<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token comment">// ç¬¬ä¸‰æ–¹åº“: è·¯å¾„é‡å†™åˆ°é¢„æ„å»ºäº§ç‰©çš„è·¯å¾„</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">BARE_IMPORT_RE</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>modSource<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">const</span> bundlePath <span class="token operator">=</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>
            path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span> <span class="token constant">PRE_BUNDLE_DIR</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>modSource<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          ms<span class="token punctuation">.</span><span class="token function">overwrite</span><span class="token punctuation">(</span>modStart<span class="token punctuation">,</span> modEnd<span class="token punctuation">,</span> bundlePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>modSource<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> modSource<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// ç›´æ¥è°ƒç”¨æ’ä»¶ä¸Šä¸‹æ–‡çš„ resolve æ–¹æ³•ï¼Œä¼šè‡ªåŠ¨ç»è¿‡è·¯å¾„è§£ææ’ä»¶çš„å¤„ç†</span>
          <span class="token keyword">const</span> resolved <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>modSource<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>resolved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ms<span class="token punctuation">.</span><span class="token function">overwrite</span><span class="token punctuation">(</span>modStart<span class="token punctuation">,</span> modEnd<span class="token punctuation">,</span> resolved<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        code<span class="token operator">:</span> ms<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// ç”Ÿæˆ SourceMap</span>
        map<span class="token operator">:</span> ms<span class="token punctuation">.</span><span class="token function">generateMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨ï¼Œæˆ‘ä»¬ä¾¿å®Œæˆäº† JS ä»£ç çš„ import åˆ†æå·¥ä½œã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŠŠä¸Šé¢å®ç°çš„ä¸‰ä¸ªæ’ä»¶è¿›è¡Œæ³¨å†Œ:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/node/plugin/index.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> esbuildTransformPlugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./esbuild&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> importAnalysisPlugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./importAnalysis&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> resolvePlugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./resolve&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Plugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../plugin&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">resolvePlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Plugin<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token function">resolvePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">esbuildTransformPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">importAnalysisPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“ç„¶ï¼Œæˆ‘ä»¬éœ€è¦æ³¨å†Œ transformMiddleware ä¸­é—´ä»¶ï¼Œåœ¨<code>src/node/server/index.ts</code>ä¸­å¢åŠ ä»£ç å¦‚ä¸‹:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">transformMiddleware</span><span class="token punctuation">(</span>serverContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ç„¶ååœ¨<code>playground</code>é¡¹ç›®ä¸‹æ‰§è¡Œ<code>pnpm dev</code>ï¼Œåœ¨æµè§ˆå™¨é‡Œé¢è®¿é—®<code>http://localhost:3000</code>ï¼Œä½ å¯ä»¥åœ¨ç½‘ç»œé¢æ¿ä¸­å‘ç° <code>main.tsx</code> çš„å†…å®¹ä»¥åŠè¢«ç¼–è¯‘ä¸ºä¸‹é¢è¿™æ ·:</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c788e41eb93c4727958b501f2314ad7d~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><p>åŒæ—¶ï¼Œé¡µé¢å†…å®¹ä¹Ÿèƒ½è¢«æ¸²æŸ“å‡ºæ¥äº†:</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dd414e4167204fa08547e27e7d465c33~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p><p>OKï¼Œç›®å‰ä¸ºæ­¢æˆ‘ä»¬å°±åŸºæœ¬ä¸Šå®Œæˆ JS/TS/JSX/TSX æ–‡ä»¶çš„ç¼–è¯‘ã€‚</p><h2 id="å°ç»“" tabindex="-1"><a class="header-anchor" href="#å°ç»“" aria-hidden="true">#</a> å°ç»“</h2><p>æœ¬å°èŠ‚çš„å†…å®¹å°±åˆ°è¿™é‡Œï¼Œç›¸ä¿¡ä½ å¦‚æœèƒ½ä¸€ç›´è·Ÿç€åšåˆ°è¿™é‡Œï¼Œä¹Ÿå·²ç»æ”¶è·æ»¡æ»¡äº†ã€‚æˆ‘ä»¬æœ€åæ¥å›é¡¾å’Œå°ç»“ä¸€ä¸‹ï¼Œè¿™ä¸€èŠ‚æˆ‘ä»¬ä¸»è¦æ¥æ‰‹å†™ Vite çš„ no-bundle æœåŠ¡ï¼Œå®Œæˆäº†<strong>å¼€å‘ç¯å¢ƒæ­å»º</strong>ã€<strong>é¢„æ„å»ºåŠŸèƒ½çš„å¼€å‘</strong>ã€<strong>æ’ä»¶æœºåˆ¶çš„æ­å»º</strong>ã€<strong>å…¥å£ HTML åŠ è½½</strong>å’Œ <strong>JS/TS/JSX/TSX çš„ç¼–è¯‘åŠŸèƒ½</strong>ã€‚</p><p>åœ¨ä¸‹ä¸€å°èŠ‚ï¼Œæˆ‘ä»¬å°†ç»§ç»­å®Œå–„å½“å‰çš„ no-bundle æœåŠ¡å™¨ï¼Œå®Œæˆ CSS ç¼–è¯‘ã€é™æ€èµ„æºåŠ è½½å’Œ HMR ç³»ç»Ÿçš„å®ç°ï¼Œè®©æˆ‘ä»¬ä¸‹ä¸€èŠ‚å†è§ğŸ‘‹ğŸ»</p>`,117);function g(y,f){const t=o("ExternalLinkIcon");return c(),i("div",null,[u,s("blockquote",null,[s("p",null,[n("æ³¨: æ‰‹å†™ Vite é¡¹ç›®çš„æ‰€æœ‰ä»£ç ï¼Œæˆ‘å·²ç»æ”¾åˆ°äº†å°å†Œçš„ Github ä»“åº“ä¸­ï¼Œ"),s("a",r,[n("ç‚¹å‡»æŸ¥çœ‹"),p(t)]),n("ã€‚")])]),k,s("p",null,[n("å¦‚æ­¤ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ä¸šåŠ¡é¡¹ç›®ä¸­ä½¿ç”¨ "),d,n(" è¿™ä¸ªå‘½ä»¤äº†ã€‚åœ¨å°å†Œçš„ Github ä»“åº“ä¸­æˆ‘ä¸ºä½ å‡†å¤‡äº†ä¸€ä¸ªç¤ºä¾‹çš„ "),v,n(" é¡¹ç›®ï¼Œä½ å¯ä»¥æ‹¿æ¥è¿›è¡Œæµ‹è¯•ï¼Œ"),s("a",m,[n("ç‚¹å‡»æŸ¥çœ‹é¡¹ç›®"),p(t)]),n("ã€‚")]),b])}const q=e(l,[["render",g],["__file","di24zhangâ€”shouxieViteï¼šshixianno-bundlekaifafuwu(shang).html.vue"]]);export{q as default};
